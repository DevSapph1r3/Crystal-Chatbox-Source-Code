<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Crystal Chatbox Dashboard</title>
<link rel="stylesheet" href="/static/style.css">
<script>
window.CONFIG = {
    refresh_interval: {{ dashboard_update_interval | default(1) }},
    customs_text: `{{ customs_text | escape | replace('\n', '\\n') }}`
};
</script>
</head>
<body class="{% if theme == 'light' %}light{% endif %} {% if compact_mode %}compact{% endif %}">
<div class="container">
    <div class="header">
        <img src="/static/logo.png" alt="Crystal Logo" class="logo" />
        <div class="h1">Crystal Chatbox Dashboard</div>
    </div>

    <div class="tabs">
        <div id="dashboard_tab" class="tab active">Dashboard</div>
        <div id="settings_tab" class="tab">Settings</div>
        <div id="advanced_tab" class="tab">Advanced</div>
    </div>

    <div id="dashboard_content" class="tabcontent" style="display:block;">
        {% if not patreon_supporter %}
        <!-- A-Ads Banner Ad 1 -->
        <div style="text-align:center;margin:12px 0;padding:8px;background:var(--card-bg);border-radius:4px;">
            <div id="a-ads-728x90" style="margin:0 auto;max-width:728px;">
                <script async src="https://ad.a-ads.com/2126442.js" type="text/javascript"></script>
            </div>
        </div>
        {% endif %}
        <div class="card">
            <form id="manual_msg_form" action="/send" method="post">
                <label>Type message to send immediately:</label>
                <input type="text" name="message" placeholder="Type message..." required />
                <div style="margin-top:8px;"><button type="submit" class="btn-on">Send</button></div>
            </form>

            <div class="row" style="margin-top:12px;">
                <div class="left card">
                    <div class="controls">
                        <button id="btn_chatbox" class="btn-off">Chatbox</button>
                        <button id="btn_time" class="btn-on">Time</button>
                        <button id="btn_custom" class="btn-on">Custom</button>
                        <button id="btn_music" class="btn-on">Music</button>
                        <button id="btn_window" class="btn-off">Active Window</button>
                        <button id="btn_heartrate" class="btn-off">Heart Rate</button>
                        <button id="btn_music_progress" class="btn-on">Music Progress</button>

                        <label style="display:block;margin-top:6px;">Progress Style:</label>
                        <select id="select_progress_style">
                            <option value="bar" {% if progress_style == 'bar' %}selected{% endif %}>Bar</option>
                            <option value="dots" {% if progress_style == 'dots' %}selected{% endif %}>Dots</option>
                            <option value="percentage" {% if progress_style == 'percentage' %}selected{% endif %}>Percentage</option>
                        </select>

                        <hr />
                        <label>Layout (drag to reorder):</label>
                        <ul id="layout_list">
                            {% set all_items = {
                                "time": "Time",
                                "custom": "Custom Message",
                                "song": "Song",
                                "window": "Active Window",
                                "heartrate": "Heart Rate"
                            } %}

                            {# Render items in the order of layout_order first #}
                            {% for key in layout_order %}
                                {% if all_items[key] is defined %}
                                    <li class="layout-item" draggable="true" data-key="{{ key }}">{{ all_items[key] }}</li>
                                {% endif %}
                            {% endfor %}

                            {# Render any items missing from layout_order at the end #}
                            {% for key, label in all_items.items() %}
                                {% if key not in layout_order %}
                                    <li class="layout-item" draggable="true" data-key="{{ key }}">{{ label }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>

                    </div>
                </div>

                <div class="right card">
                    {% if not patreon_supporter %}
                    <!-- A-Ads Square Ad 2 -->
                    <div style="text-align:center;margin:0 0 16px 0;padding:8px;">
                        <div id="a-ads-300x250" style="margin:0 auto;max-width:300px;">
                            <script async src="https://ad.a-ads.com/2126443.js" type="text/javascript"></script>
                        </div>
                    </div>
                    {% endif %}
                    <div class="status-line"><strong>Chatbox:</strong> <pre id="chatbox_status" class="multiline">?</pre></div>
                    <div class="status-line"><strong>Time:</strong> <pre id="time_status" class="multiline">?</pre></div>
                    <div class="status-line"><strong>Custom Message:</strong> <pre id="custom_status" class="multiline">?</pre></div>
                    <div class="status-line"><strong>Current Song:</strong> <pre id="song_status" class="multiline">?</pre></div>
                    <div class="status-line"><strong>Active Window:</strong> <pre id="window_status" class="multiline">?</pre></div>
                    <div class="status-line"><strong>Heart Rate:</strong> <pre id="heartrate_status" class="multiline">?</pre></div>
                    <div class="status-line"><strong>Last Sent:</strong> <pre id="last_msg" class="multiline">---</pre></div>

                    <div class="preview fixed-preview" id="preview">Preview will show here.</div>
                    <img id="album_art" class="album" src="" alt="" />
                    
                    <div style="margin-top:10px;">
                        <strong>Next Messages:</strong>
                        <div id="message_queue" style="margin-top:4px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings_content" class="tabcontent" style="display:none;">
        <div class="card">
            <form action="/save_settings" method="post">
                <label>Quest or Desktop IP:</label>
                <input type="text" name="quest_ip" value="{{ quest_ip }}" required />
                <label>Quest Port:</label>
                <input type="number" name="quest_port" value="{{ quest_port }}" required />
                <label>OSC Send Interval (seconds):</label>
                <input type="number" name="osc_send_interval" value="{{ osc_send_interval }}" required />
                <label>Dashboard Update Interval (seconds):</label>
                <input type="number" name="dashboard_update_interval" value="{{ dashboard_update_interval }}" required />
                <label>Timezone:</label>
                <select name="timezone">
                    <option value="local" {% if timezone == 'local' %}selected{% endif %}>Local</option>
                    {% for tz in timezones %}
                    <option value="{{ tz }}" {% if timezone==tz %}selected{% endif %}>{{ tz }}</option>
                    {% endfor %}
                </select>

                <hr />
                
                <h3>Spotify Integration Setup</h3>
                <div style="background:#2a2a2a;padding:12px;border-radius:8px;margin-bottom:12px;font-size:13px;line-height:1.6;">
                    <strong>Setup Instructions:</strong>
                    <ol style="margin:8px 0;padding-left:20px;">
                        <li>Go to <a href="https://developer.spotify.com/dashboard" target="_blank" style="color:#00bfff;">Spotify Developer Dashboard</a></li>
                        <li>Create a new app (or use an existing one)</li>
                        <li>Copy the <strong>Client ID</strong> and <strong>Client Secret</strong> below</li>
                        <li>Add this <strong>Redirect URI</strong> to your Spotify app settings:</li>
                    </ol>
                    <div style="background:#0d0d0d;padding:8px;border-radius:4px;font-family:monospace;margin:8px 0;word-break:break-all;">
                        {{ spotify_redirect_uri }}
                    </div>
                    <div style="margin-top:8px;padding:8px;background:#1a1a1a;border-left:3px solid #f39c12;font-size:12px;">
                        <strong>‚ö†Ô∏è Windows Users:</strong> Use <code style="background:#0d0d0d;padding:2px 6px;border-radius:2px;">http://127.0.0.1:5000/spotify-callback</code> instead of localhost in your Spotify app settings for compatibility.
                    </div>
                    <div style="margin-top:8px;color:#999;font-size:12px;">
                        üí° After saving, you'll need to authorize this app to access your Spotify account.
                    </div>
                </div>
                
                <label>Spotify Client ID:</label>
                <input type="text" name="spotify_client_id" value="{{ spotify_client_id }}" placeholder="Enter your Spotify Client ID" />
                <label>Spotify Client Secret:</label>
                <input type="text" name="spotify_client_secret" value="{{ spotify_client_secret }}" placeholder="Enter your Spotify Client Secret" />

                <div style="margin-top:12px;">
                    <button type="submit" class="btn-on">Save Settings</button>
                </div>
            </form>

            <hr />
            
            <div>
                <label>Custom Messages:</label>
                <div id="inline_messages_container" style="margin-top:8px;"></div>
                <button id="add_message_btn" class="btn-on" style="margin-top:8px;">Add New Message</button>
            </div>
        </div>
    </div>

    <div id="advanced_content" class="tabcontent" style="display:none;">
        <div class="card">
            <h3>Message Options</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                <button id="random_order_btn" class="btn-{% if random_order %}on{% else %}off{% endif %}">Random Order: {% if random_order %}ON{% else %}OFF{% endif %}</button>
                <button id="show_module_icons_btn" class="btn-{% if show_module_icons %}on{% else %}off{% endif %}">Module Icons: {% if show_module_icons %}ON{% else %}OFF{% endif %}</button>
            </div>
            
            <hr />
            
            <h3>Per-Message Timing</h3>
            <label>Set custom intervals for each message (seconds):</label>
            <div id="per_message_timing_container" style="margin-top:8px;"></div>
            
            <div id="message_weights_section" style="{% if not random_order %}display:none;{% endif %}">
                <hr />
                
                <h3>Message Weights (for random order)</h3>
                <label>Higher weight = appears more often:</label>
                <div id="message_weights_container" style="margin-top:8px;"></div>
            </div>
            
            <hr />
            
            <h3>Display Options</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button id="toggle_theme_btn" class="btn-{% if theme == 'light' %}on{% else %}off{% endif %}">Theme: {% if theme == 'light' %}Light{% else %}Dark{% endif %}</button>
                <button id="toggle_streamer_btn" class="btn-{% if streamer_mode %}on{% else %}off{% endif %}">Streamer Mode: {% if streamer_mode %}ON{% else %}OFF{% endif %}</button>
                <button id="toggle_compact_btn" class="btn-{% if compact_mode %}on{% else %}off{% endif %}">Compact Mode: {% if compact_mode %}ON{% else %}OFF{% endif %}</button>
            </div>
            
            <hr />
            
            <h3>Custom Emojis</h3>
            <label>Customize the emojis for each module:</label>
            <div style="margin-top:8px;">
                <label>Time Emoji:</label>
                <input type="text" id="time_emoji" value="{{ time_emoji }}" maxlength="5" placeholder="‚è∞" />
                <label>Song Emoji:</label>
                <input type="text" id="song_emoji" value="{{ song_emoji }}" maxlength="5" placeholder="üé∂" />
                <label>Window Emoji:</label>
                <input type="text" id="window_emoji" value="{{ window_emoji }}" maxlength="5" placeholder="üíª" />
                <label>Heart Rate Emoji:</label>
                <input type="text" id="heartrate_emoji" value="{{ heartrate_emoji }}" maxlength="5" placeholder="‚ù§Ô∏è" />
                <button id="save_emojis_btn" class="btn-on" style="margin-top:8px;">Save Emojis</button>
            </div>
            
            <hr />
            
            <h3>Window Tracking</h3>
            <label>Track your active application/browser tab (PC/Laptop only):</label>
            <div style="margin-top:8px;">
                <button id="toggle_window_tracking_btn" class="btn-{% if window_tracking_enabled %}on{% else %}off{% endif %}">Window Tracking: {% if window_tracking_enabled %}ON{% else %}OFF{% endif %}</button>
                <div style="margin-top:12px;">
                    <label>Tracking Mode:</label>
                    <select id="window_tracking_mode" style="width:100%;padding:6px;margin-top:4px;background:var(--input-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;">
                        <option value="both" {% if window_tracking_mode == 'both' %}selected{% endif %}>Both (App + Browser Tabs)</option>
                        <option value="app" {% if window_tracking_mode == 'app' %}selected{% endif %}>App Only (No Browser Tabs)</option>
                        <option value="browser" {% if window_tracking_mode == 'browser' %}selected{% endif %}>Browser Tabs Only</option>
                    </select>
                </div>
                <div style="margin-top:8px;color:#999;font-size:12px;">
                    Note: Window tracking is cross-platform (Windows, macOS, Linux). It shows what application or browser tab you're currently using. This feature requires the app to run on your local machine.
                </div>
            </div>
            
            <hr />
            
            <h3>Heart Rate Monitor</h3>
            <label>Connect your heart rate monitor to display BPM in VRChat:</label>
            <div style="margin-top:8px;">
                <button id="toggle_heart_rate_enabled_btn" class="btn-{% if heart_rate_enabled %}on{% else %}off{% endif %}">Heart Rate Tracking: {% if heart_rate_enabled %}ON{% else %}OFF{% endif %}</button>
                <div style="margin-top:12px;">
                    <label>Heart Rate Source:</label>
                    <select id="heart_rate_source" style="width:100%;padding:6px;margin-top:4px;background:var(--input-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;">
                        <option value="pulsoid" {% if heart_rate_source == 'pulsoid' %}selected{% endif %}>Pulsoid</option>
                        <option value="hyperate" {% if heart_rate_source == 'hyperate' %}selected{% endif %}>HypeRate.io</option>
                        <option value="custom" {% if heart_rate_source == 'custom' %}selected{% endif %}>Custom API</option>
                    </select>
                </div>
                <div id="pulsoid_settings" style="margin-top:12px;{% if heart_rate_source != 'pulsoid' %}display:none;{% endif %}">
                    <label>Pulsoid API Token:</label>
                    <input type="text" id="heart_rate_pulsoid_token" value="{{ heart_rate_pulsoid_token }}" placeholder="Enter your Pulsoid API token" />
                    <div style="margin-top:8px;color:#999;font-size:12px;">
                        Get your token from <a href="https://pulsoid.net/ui/keys" target="_blank" style="color:#00bfff;">Pulsoid Developer Page</a>
                    </div>
                </div>
                <div id="hyperate_settings" style="margin-top:12px;{% if heart_rate_source != 'hyperate' %}display:none;{% endif %}">
                    <label>HypeRate Session ID:</label>
                    <input type="text" id="heart_rate_hyperate_id" value="{{ heart_rate_hyperate_id }}" placeholder="Enter your HypeRate session ID" />
                    <div style="margin-top:8px;color:#999;font-size:12px;">
                        Get your session ID from <a href="https://www.hyperate.io/" target="_blank" style="color:#00bfff;">HypeRate.io</a>
                    </div>
                </div>
                <div id="custom_api_settings" style="margin-top:12px;{% if heart_rate_source != 'custom' %}display:none;{% endif %}">
                    <label>Custom API URL:</label>
                    <input type="text" id="heart_rate_custom_api" value="{{ heart_rate_custom_api }}" placeholder="https://your-api.com/heartrate" />
                    <div style="margin-top:8px;color:#999;font-size:12px;">
                        API should return JSON with "bpm", "heart_rate", or "hr" field
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <label>Update Interval (seconds):</label>
                    <input type="number" id="heart_rate_update_interval" value="{{ heart_rate_update_interval }}" min="1" max="60" />
                </div>
                <button id="save_heart_rate_settings_btn" class="btn-on" style="margin-top:8px;">Save Heart Rate Settings</button>
            </div>
            
            <hr />
            
            <h3>Support the Developer</h3>
            <div style="background:#2a2a2a;padding:16px;border-radius:8px;margin-bottom:12px;">
                <p style="margin-top:0;">If you enjoy using this dashboard, please consider supporting me on Patreon!</p>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
                    <a href="https://patreon.com/Sapph1r3?utm_medium=unknown&utm_source=join_link&utm_campaign=creatorshare_creator&utm_content=copyLink" target="_blank" style="text-decoration:none;">
                        <button class="btn-on">Support on Patreon</button>
                    </a>
                    <a href="https://www.patreon.com/15093289/join" target="_blank" style="text-decoration:none;">
                        <button class="btn-on">Join Patreon</button>
                    </a>
                </div>
                <div style="margin-top:12px;">
                    <button id="toggle_patreon_btn" class="btn-{% if patreon_supporter %}on{% else %}off{% endif %}">Patreon Supporter: {% if patreon_supporter %}YES{% else %}NO{% endif %}</button>
                    <div style="margin-top:8px;color:#999;font-size:12px;">
                        Click to enter your unique supporter license key (provided on Patreon) to unlock premium customization features!
                        <br>Each Patreon supporter receives a personalized license key. Contact the developer if you need your key.
                    </div>
                </div>
            </div>
            
            <div id="premium_styling_section" style="{% if not patreon_supporter %}opacity:0.5;pointer-events:none;{% endif %}">
                <h3>Premium Customization {% if not patreon_supporter %}(Patreon Supporters Only){% endif %}</h3>
                <label>Custom Background (URL or hex color):</label>
                <input type="text" id="custom_background" value="{{ custom_background }}" placeholder="https://... or #1a1a1a" {% if not patreon_supporter %}disabled{% endif %} />
                <label>Custom Button Color (hex color):</label>
                <input type="text" id="custom_button_color" value="{{ custom_button_color }}" placeholder="#27ae60" {% if not patreon_supporter %}disabled{% endif %} />
                <button id="save_premium_styling_btn" class="btn-on" style="margin-top:8px;" {% if not patreon_supporter %}disabled{% endif %}>Save Premium Styling</button>
            </div>
            
            <hr />
            
            <h3>Backup & Restore</h3>
            <div style="margin-bottom:12px;">
                <button id="download_settings_btn" class="btn-on">Download Settings</button>
                <button id="download_log_btn" class="btn-on" style="margin-left:8px;">Download Error Log</button>
                <button id="reset_defaults_btn" class="btn-off" style="margin-left:8px;">Reset to Defaults</button>
            </div>
            <div style="margin-top:12px;">
                <input type="file" id="upload_settings_file" accept=".json" style="display:none;" />
                <button id="upload_settings_btn" class="btn-on">Upload Settings</button>
                <div style="margin-top:8px;color:#999;font-size:12px;">
                    Upload a previously downloaded settings.json file to restore your configuration.
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-content">
        <div class="footer-made-by">Made by Sapph1r3</div>
        <div class="footer-links">
            <a href="https://vrchat.com/home/user/usr_d5b25d37-63ff-45b8-9a4a-9a0a1f6e05b0" target="_blank" class="footer-link">
                üéÆ VRChat: Sapph1r3
            </a>
            <a href="https://discord.com/users/Bxpq" target="_blank" class="footer-link">
                üí¨ Discord: Bxpq
            </a>
            <a href="https://discord.gg/3Qypg9vnEP" target="_blank" class="footer-link">
                üåê Community Server
            </a>
            <a href="https://patreon.com/Sapph1r3" target="_blank" class="footer-link">
                ‚ù§Ô∏è Support on Patreon
            </a>
        </div>
    </div>
</footer>

<script src="/static/script.js"></script>
</body>
</html>
